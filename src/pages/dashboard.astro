---
import Layout from "@/layouts/Layout.astro";
import { AuthenticatedNavigation } from "@/components/layout/AuthenticatedNavigation";
import { DashboardContent } from "@/components/dashboard/DashboardContent";
import { ToasterProvider } from "@/components/ToasterProvider";

// Wymaga SSR dla sprawdzenia autentykacji
export const prerender = false;
// Server-side: jeśli użytkownik nie ma preferencji → redirect na onboarding
const preferencesResponse = await fetch(`${Astro.url.origin}/api/preferences`, {
  headers: {
    cookie: Astro.request.headers.get("cookie") || "",
  },
});

if (preferencesResponse.status === 404) {
  return Astro.redirect("/onboarding");
}

// TYMCZASOWO WYŁĄCZONE DLA TESTÓW - używamy DEFAULT_USER_ID
// TODO: Przywrócić auth check przed deployem do produkcji
// const {
//   data: { user },
//   error,
// } = await Astro.locals.supabase.auth.getUser();

// // Jeśli niezalogowany, przekieruj do strony głównej
// if (error || !user) {
//   return Astro.redirect("/");
// }

const currentPath = Astro.url.pathname;
---

<Layout title="Dashboard - AI Meal Planner">
  <AuthenticatedNavigation currentPath={currentPath} client:load />
  <main class="container mx-auto py-8 px-4 min-h-screen">
    <DashboardContent client:load />
  </main>
  <ToasterProvider client:only="react" />
</Layout>
